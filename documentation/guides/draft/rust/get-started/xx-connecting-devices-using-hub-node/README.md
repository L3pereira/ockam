# Connecting devices using Hub Node

## Introduction

In the previous guide we learned how to [create a Hub Node](../xx-hub-node) and use services there using the TCP transport.

Hub Nodes can be used as proxies to connect devices not exposed by public hostnames or IPs. The cloud node can forward the traffic from one device to another using the Ockam Transport connections established by device nodes.

## Discovery using forwarding

To reach another worker in an Ockam Network, sender worker has to be aware of the route to destination worker.
If we're connecting device nodes over a Hub Node using TCP connection, this route would lead through a TCP connections which are dynamic and not exposed to the device nodes.

In order to allow another device to forward messages to this route, we can create a Forwarding Address for this route by registering in the Forwarding Service.
All messages sent to the Forwarding Address will be redirected to the registered route.

After that, the routes in the message can trace path between device workers and these workers can exchange messages.

<img src="./Discovery.png" width="70%">

Ockam Rust library provides an API to use Forwarding Service

```rust
pub async fn create<A: Into<Address>, S: Into<Route>>(
    ctx: &Context,
    hub_route: R,
    destination: A,
)
```

Where `hub_route` is a route to the Hub Node and `destination` is a local address to which messages will be forwarded.

For example `RemoteForwarder::create(&ctx, route![(TCP, "127.0.0.1:4000")], "echoer");` would register a Forwarding Address to the local "echoer" worker.

This function returns the following data structure:
```rust
pub struct RemoteForwarderInfo {
    forwarding_route: Route,
    remote_address: String,
    worker_address: Address,
}
```

Where

`remote_address` is the Forwarding Address address on the Hub Node
`forwarding_route` is a **full route** to the Forwarding Address on the Hub Node (this route includes TCP transport)
`worker_address` is the local address of the forwarding worker


## Application code

In this example we're going to connect two nodes using the Forwarding Service

One node we call "responder", it will run an "echoer" service and will register a route with the Forwarding Service.
The Forwarding Address it registers will be shown to be used by another node.

Another node we call "initiator", it will use the Forwarding Address generated by responder to send a message.


### Responder

First create a responder at:

```
touch examples/xx-connecting-devices-using-hub-node-responder.rs
```

Add the following code to this file:

```rust
use ockam::{Context, RemoteForwarder, Result, TcpTransport};
use ockam_get_started::Echoer;

#[ockam::node]
async fn main(ctx: Context) -> Result<()> {
    // Create a cloud node by going to https://hub.ockam.network
    let cloud_node_tcp_address = "<Your node Address copied from hub.ockam.network>"; // e.g. "127.0.0.1:4000"

    // Initialize the TCP Transport.
    let tcp = TcpTransport::create(&ctx).await?;

    // Create a TCP connection to your cloud node.
    tcp.connect(cloud_node_tcp_address).await?;

    // Create an echoer worker
    ctx.start_worker("echoer", Echoer).await?;

    let forwarder = RemoteForwarder::create(&ctx, route![(TCP, cloud_node_tcp_address)], "echoer").await?;
    println!(
        "Forwarding Address of echoer: {}",
        forwarder.remote_address()
    );

    Ok(())
}
```

This node will run an `echoer` worker to reply to the messages sent from the initiator node.

### Run responder

You need to get the Forwarding Address from the Hub Node first in order to configure the initiator properly.

To do that run:

```
cargo run --example xx-connecting-devices-using-hub-node-responder
```

You will see the log message `Forwarding Address: ...` - copy the address from here

### Initiator

```
touch examples/xx-connecting-devices-using-hub-node-initiator.rs
```

Add the following code to this file (replace fields in `<>` with values you copied):

```rust
// This node routes a message, to a different node, using a forwarding address on the cloud node.

use ockam::{route, Context, Result, TcpTransport, TCP};

#[ockam::node]
async fn main(mut ctx: Context) -> Result<()> {
    // Create a cloud node by going to https://hub.ockam.network
    let cloud_node_tcp_address = "<Your node Address copied from hub.ockam.network>"; // e.g. "127.0.0.1:4000"

    // Run xx-connecting-devices-using-hub-node-responder,
    // it will print the forwarding address of echoer on your cloud node
    let echoer_forwarding_address = "<Address copied from responder output>";

    // Initialize the TCP Transport.
    let tcp = TcpTransport::create(&ctx).await?;

    // Create a TCP connection to your cloud node.
    tcp.connect(cloud_node_tcp_address).await?;

    // Send a message to the echoer worker, on a different node,
    // using a forwarding address on your cloud node
    ctx.send(
        route![(TCP, cloud_node_tcp_address), echoer_forwarding_address],
        "Hello Ockam!".to_string(),
    )
    .await?;

    // Wait to receive a reply and print it.
    let reply = ctx.receive::<String>().await?;
    println!("App Received: {}", reply); // should print "Hello Ockam!"

    // Stop all workers, stop the node, cleanup and return.
    ctx.stop().await
}

```

### Run initiator

```
cargo run --example xx-connecting-devices-using-hub-node-initiator
```

You should expect a log message `App Received: Hello Ockam!`


## Message flow


<img src="./Sequence.png" width="100%">


<div style="display: none; visibility: hidden;">
<hr><b>Next:</b> <a href="../xx-secude-channel-over-cloud-node">XX. Secure channel over cloud node</a>
</div>

